{% extends "base.html" %}

{% block title %}AI Performance Insights - Stockly{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-brain"></i> AI Performance Insights</h2>
                {% if has_portfolio %}
                <button class="btn btn-primary" onclick="generateNewInsights()" id="generateBtn">
                    <i class="fas fa-sync"></i> Generate New Insights
                </button>
                {% endif %}
            </div>

            <!-- Coming Soon Banner -->
            <div class="alert alert-info mb-4">
                <h5><i class="fas fa-info-circle"></i> Coming Soon!</h5>
                <p class="mb-0">AI Performance Insights are currently in development. This is a preview of the AI analysis system with sample data. Real-time insights will be available soon!</p>
            </div>

            {% if not has_portfolio %}
            <!-- No Portfolio State -->
            <div class="empty-state">
                <i class="fas fa-chart-line"></i>
                <h4>No Portfolio Data</h4>
                <p>You need to add some stocks to your portfolio before we can generate AI insights.</p>
                <a href="{{ url_for('add_holding') }}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Add Your First Stock
                </a>
            </div>
            {% else %}
            <!-- Portfolio Performance Summary -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-chart-pie"></i> Portfolio Performance Summary</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 text-center">
                            <div class="performance-metric">
                                <h3 class="text-primary">${{ "%.2f"|format(performance_data.total_value) }}</h3>
                                <small class="text-muted">Total Value</small>
                            </div>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="performance-metric">
                                <h3 class="text-info">${{ "%.2f"|format(performance_data.total_cost) }}</h3>
                                <small class="text-muted">Total Cost</small>
                            </div>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="performance-metric">
                                <h3 class="{% if performance_data.total_gain_loss >= 0 %}text-success{% else %}text-danger{% endif %}">
                                    ${{ "%.2f"|format(performance_data.total_gain_loss) }}
                                </h3>
                                <small class="text-muted">Gain/Loss</small>
                            </div>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="performance-metric">
                                <h3 class="{% if performance_data.total_gain_loss_pct >= 0 %}text-success{% else %}text-danger{% endif %}">
                                    {{ "%.1f"|format(performance_data.total_gain_loss_pct) }}%
                                </h3>
                                <small class="text-muted">Return %</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Individual Stock Performance -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-list"></i> Individual Stock Performance</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-dark table-hover">
                            <thead>
                                <tr>
                                    <th>Stock</th>
                                    <th>Shares</th>
                                    <th>Current Price</th>
                                    <th>Purchase Price</th>
                                    <th>Gain/Loss</th>
                                    <th>Return %</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for stock in performance_data.stocks %}
                                <tr>
                                    <td><strong>{{ stock.ticker }}</strong></td>
                                    <td>{{ stock.shares }}</td>
                                    <td>${{ "%.2f"|format(stock.current_price) }}</td>
                                    <td>${{ "%.2f"|format(stock.purchase_price) }}</td>
                                    <td class="{% if stock.gain_loss >= 0 %}text-success{% else %}text-danger{% endif %}">
                                        ${{ "%.2f"|format(stock.gain_loss) }}
                                    </td>
                                    <td class="{% if stock.gain_loss_pct >= 0 %}text-success{% else %}text-danger{% endif %}">
                                        {{ "%.1f"|format(stock.gain_loss_pct) }}%
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- AI Insights Display -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-robot"></i> AI Performance Analysis</h5>
                    <small class="text-muted" id="insights-timestamp">
                        Generated: {{ performance_data.timestamp[:19].replace('T', ' ') if performance_data else 'Never' }}
                    </small>
                </div>
                <div class="card-body">
                    <div id="insights-content">
                        {% if insights %}
                        <div class="ai-insights">
                            <div class="insights-text">
                                {{ insights|replace('\n', '<br>')|safe }}
                            </div>
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-brain fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No insights generated yet</h5>
                            <p class="text-muted">Click "Generate New Insights" to get AI analysis of your portfolio performance.</p>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Loading State -->
                    <div id="insights-loading" style="display: none;">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-3 text-muted">AI is analyzing your portfolio...</p>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <div class="col-md-4">
            <!-- Quick Actions -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-bolt"></i> Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('portfolio') }}" class="btn btn-outline-primary">
                            <i class="fas fa-chart-line"></i> View Portfolio
                        </a>
                        <a href="{{ url_for('add_holding') }}" class="btn btn-outline-success">
                            <i class="fas fa-plus"></i> Add Stock
                        </a>
                        <button class="btn btn-outline-info" onclick="refreshPerformanceData()">
                            <i class="fas fa-sync"></i> Refresh Data
                        </button>
                    </div>
                </div>
            </div>

            <!-- How It Works -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-question-circle"></i> How It Works</h5>
                </div>
                <div class="card-body">
                    <ol class="small">
                        <li class="mb-2">AI analyzes your current portfolio performance</li>
                        <li class="mb-2">Compares current prices to your purchase prices</li>
                        <li class="mb-2">Identifies the biggest gainers and losers</li>
                        <li class="mb-2">Provides simple explanations in plain English</li>
                        <li class="mb-2">Offers educational insights about market behavior</li>
                    </ol>
                </div>
            </div>

            <!-- Coming Soon Features -->
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5><i class="fas fa-rocket"></i> Coming Soon</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled">
                        <li><i class="fas fa-check text-success"></i> Historical performance analysis</li>
                        <li><i class="fas fa-check text-success"></i> Market trend explanations</li>
                        <li><i class="fas fa-check text-success"></i> Risk assessment insights</li>
                        <li><i class="fas fa-check text-success"></i> Personalized recommendations</li>
                        <li><i class="fas fa-check text-success"></i> Sector performance analysis</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.performance-metric {
  padding: 16px;
  border-radius: 8px;
  background: rgba(79, 140, 255, 0.05);
  border: 1px solid rgba(79, 140, 255, 0.1);
}

.ai-insights {
  background: linear-gradient(135deg, rgba(79, 140, 255, 0.05), rgba(34, 197, 94, 0.05));
  border: 1px solid rgba(79, 140, 255, 0.2);
  border-radius: 12px;
  padding: 24px;
  margin: 16px 0;
}

.insights-text {
  font-size: 1.1rem;
  line-height: 1.7;
  color: var(--text);
}

.insights-text br {
  margin-bottom: 12px;
}

.table-dark {
  --bs-table-bg: var(--card);
  --bs-table-color: var(--text);
  --bs-table-border-color: #2a2d35;
}

.table-dark th {
  border-color: #2a2d35;
  color: var(--accent);
  font-weight: 600;
}

.table-dark td {
  border-color: #2a2d35;
}

.empty-state {
  text-align: center;
  padding: 60px 20px;
}

.empty-state i {
  font-size: 4rem;
  color: var(--muted);
  margin-bottom: 24px;
}

.empty-state h4 {
  color: var(--muted);
  margin-bottom: 16px;
}

.empty-state p {
  color: var(--muted);
  margin-bottom: 24px;
}

.spinner-border {
  width: 3rem;
  height: 3rem;
}
</style>

<script>
function generateNewInsights() {
  const generateBtn = document.getElementById('generateBtn');
  const insightsContent = document.getElementById('insights-content');
  const insightsLoading = document.getElementById('insights-loading');
  const timestampElement = document.getElementById('insights-timestamp');
  
  // Show loading state
  generateBtn.disabled = true;
  generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
  insightsContent.style.display = 'none';
  insightsLoading.style.display = 'block';
  
  // Make API call
  fetch('/insights/generate', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Update insights content
      insightsContent.innerHTML = `
        <div class="ai-insights">
          <div class="insights-text">
            ${data.insights.replace(/\n/g, '<br>')}
          </div>
        </div>
      `;
      
      // Update timestamp
      const timestamp = new Date(data.timestamp).toLocaleString();
      timestampElement.textContent = `Generated: ${timestamp}`;
    } else {
      insightsContent.innerHTML = `
        <div class="alert alert-danger">
          <i class="fas fa-exclamation-triangle"></i>
          Error generating insights: ${data.error}
        </div>
      `;
    }
  })
  .catch(error => {
    console.error('Error:', error);
    insightsContent.innerHTML = `
      <div class="alert alert-danger">
        <i class="fas fa-exclamation-triangle"></i>
        Error generating insights. Please try again.
      </div>
    `;
  })
  .finally(() => {
    // Hide loading state
    insightsLoading.style.display = 'none';
    insightsContent.style.display = 'block';
    generateBtn.disabled = false;
    generateBtn.innerHTML = '<i class="fas fa-sync"></i> Generate New Insights';
  });
}

function refreshPerformanceData() {
  fetch('/insights/api/performance')
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        console.error('Error refreshing data:', data.error);
        return;
      }
      
      // Reload the page to show updated data
      location.reload();
    })
    .catch(error => {
      console.error('Error refreshing data:', error);
    });
}
</script>
{% endblock %}
